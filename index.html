<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>Cancellations</title>
		<!-- Reveal CSS -->
		<link rel="stylesheet" href="css/reveal.css">
		<!-- Theme used from Reveal JS-->
		<link rel="stylesheet" href="css/theme/black.css">
		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">
		<!--Font import-->
		<link href="https://fonts.googleapis.com/css?family=Oswald" rel="stylesheet">
		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section data-background-color="black">
					<img id="cog" src="assets/img/cog.png">
					<h1>Cancellations at<br>
						General Assembly</h1>
				</section>
				<section>
					<section data-background-image="assets/img/flamingos.gif">
						<h1>THE PROBLEM</h1>
					</section>
					<section>
						<div style="float:left; width:65%">
							<h2 style="margin-top:50px">Business Understanding</h2>
							<h4 style="margin-top:50px">Enrolments either (1) cancel or (2) become students.</h4>
							<p class="emphasis" style="margin-top:50px">Some  enrolments never start their course. Around 17.82% of all enrolments cancel before their first day.</p>
							<p class="emphasis">This causes loss of income, difficulty in forecasting and wasted resourcing.</p>
						</div>
						<img id="flowchart" src="assets/img/flow.png" style="float:right"/>
					</section>
					<section>
						<h2>END GOALS:</h2>
						<h4>1. Know them</h4>
						<div class="emphasis" style="margin-bottom:20px">Accurately predict whether a student will cancel from their course.</div>
						<h4>2. Stop them</h4>
						<div class="emphasis" >Explore any actionable insights in preventing cancellations.</div>
					</section>
				</section>
				<section>
					<section data-background-image="assets/img/rubixcube.gif">
						<h1>THE SOLUTION</h1>
					</section>
					<section>
						<h2>1. KNOW THEM</h2>
					</section>
					<section>
						<h2>2. STOP THEM</h2>
					</section>
				</section>
				<section>
					<section data-background-image="assets/img/matrixdata.gif">
						<h1>THE PROCESS</h1>
					</section>
					<section>
						<h1>THE PROCESS</h1>
						<div>
							<h6>STEP 1: EXPORT</h6>
							<h6>STEP 2: DATA UNDERSTANDING</h6>
							<h6>STEP 3: DATA PREPARATION</h6>
							<h6>STEP 4: MODELING</h6>
							<h6>STEP 5: EVALUATION</h6>
						</div>
					</section>
					<section>
						<h1>THE PROCESS</h1>
						<div >
							<h6>STEP 6: REPEAT STEPS 3-5</h6>
							<h6>STEP 7: AND AGAIN</h6>
							<h6>STEP 8: AND AGAIN</h6>
							<h6>STEP 9: AND AGAIN</h6>
							<h6>STEP 10: DEPLOY</h6>
						</div>
					</section>
					<section>
						<h2>DATA UNDERSTANDING</h2>
						<h3>EXPORTING THE DATA</h3>
						<p>Export the data from Looker and download it as a CSV, then read it into Python.</p>
						<div class="coding">enrolments = pd.read_csv("data/courses snap_sales_funnel 2017-07-05T1254.csv", low_memory=False)</div>
						<div style="width:100%; text-align:left; padding-top:30px">
							<ul>
								<li>Metro - which city were they enrolled in?</li>
								<li>Expected Payment - how did we expect them to pay?</li>
								<li>Application Type - how did they apply?</li>
								<li>Pardot Category - how did they find General Assembly?</li>
							</ul>
						</div>
						<h3>EXTRAPOLATING THE DATA</h3>
						<div class="coding">enrolments['Cancelled'] = enrolments.CanceledDate.notnull()<br>
							enrolments['APAC'] = enrolments['Metro'].isin(['sydney','melbourne','hong-kong','singapore','brisbane'])</div>
					</section>
					<section>
						<h3>VISUALISING THE DATA</h3>
						<div style="float:left; width:49%"><p style="margin:0px">Cancellations by month</p>
						<!--<p>Although enrolment numbers are down, cancellations are steady:</p>-->
						<img src="assets/img/cancellations-by-month.png"/></div>
						<div style="float:right; width:49%"><p style="margin:0px">Days from Enrolment to Startdate</p>
						<!--<p>Students enrol close to the start date of their course: </p>-->
						<img src="assets/img/daysenroltostart-hist.png" width="407px"/></div>
						<div style="float:left; width:49%"><p style="margin:0px">Cancellations by metro</p>
						<!--<p>Sydney actually has a lower rate of cancellations than other metros:</p>-->
						<img src="assets/img/cancellations-by-metro.png"/></div>
						<div style="float:right; width:49%"><p style="margin:0px">Payment methods</p>
						<!--<p>Students who are paying by private loan or on their own pocket are more likely to cancel than employer-paid:</p>-->
						<img src="assets/img/cancellations-by-pay-method.png"/></div>
					</section>
					<section>
						<h2>DATA PREPARATION</h2>
						<h5>COMPLETING THE DATA</h5>
						<!--<p>A lot of the missing data was cleared just by limiting the data to post mid-2014 and pre mid-2017.</p>-->
						<div class="coding">enrolments = enrolments[enrolments.EnrolDate > 20140630]<br>
							enrolments = enrolments[enrolments.EnrolDate < 20170630]</div>
						<!--<p>Other null values were relatively easy to fix using the mean or simply entering "Unknown" for categorical variables.</p>-->
						<div class="coding">enrolments.DaysEnroltoStart.fillna(enrolments.DaysEnroltoStart.mean(), inplace=True)<br>
							enrolments.ExpectedPayment.fillna("Unknown", inplace=True)</div>
						<h5>STREAMLINING THE DATA</h5>
						<!--<p>Some variables had ad hoc entries as well as clear categories.</p>-->
						<div class="coding">commonapptypes = enrolments.ApplicationType.value_counts().index[enrolments.ApplicationType. value_counts()>100]<br>
							enrolments = enrolments[enrolments.ApplicationType.isin(commonapptypes)]</div>
						<h5>DUMMYING THE DATA</h5>
						<!--<p>Some algorithms only accept numerical or boolean inputs, so the categorical data had to be 'dummied up'. </p>-->
						<div class="coding">dummydata = pd.get_dummies(data=enrolments, columns = ['Metro','Course','Type','ExpectedPayment','ApplicationType','PardotCategory','EnrolDay'], prefix = ['Metro','Course','Type','ExpectedPayment','ApplicationType','PardotCategory','EnrolDay'] )<br>dummydata.shape</div>
						<div class="output">
							30293, 100
						</div>
					</section>
					<section>
						<h2>MODELING</h2>
						<h3>CHOOSING THE MODEL</h3>
						<p><em>Classification problem</em>: Students either cancel or don't cancel.</p>
						<p><em>Unbalanced data</em>: Cancelled students only accounted for 17% of the data; even a random pick will predict a non-cancelled student correctly 83% of the time.</p>
					</section>
					<section>
						<h2>EVALUATION</h2>
						<p> Method needs to be: uniform and based how we want to use the model.</p>
						<p> Cancellation is like medical diagnosis - we care more about false negatives (i.e. predicted not cancelled and then they cancel); we don't care that much about false positives (i.e. predicted cancelled and then they don't cancel).  </p>
						<p> Comparing models using: Confusion Matrix, Specificity, Sensitivity, AUC ROC. </p>
						<div class="coding">
							from sklearn.dummy import DummyClassifier<br>
							dumb = DummyClassifier(strategy='most_frequent')<br>
							dumb.fit(X_train, y_train)<br>
							y_dumb_class = dumb.predict(X_test)<br>
						</div>
					</section>
					<section>
						<h5>Baseline</h5>
						<div class="coding" style="clear:both;width:100%">
							from sklearn.dummy import DummyClassifier<br>
							dumb = DummyClassifier(strategy='most_frequent')<br>
							dumb.fit(X_train, y_train)<br>
						</div>
						<div style="clear:both;width:100%">
							<div class="coding" style="float:left; width:50%">
								y_dumb_class = dumb.predict(X_test)<br>
								print ('Accuracy Score: ', metrics.accuracy_score(y_test, y_dumb_class))<br>
								print('Confusion Matrix: ', metrics.confusion_matrix(y_test, y_dumb_class))<br>
								print('Sensitivity:',(confusion_matrix[0,0]/(confusion_matrix[0,1]+ confusion_matrix[0,0])))<br>
								print('Specificity:',(confusion_matrix[1,1]/(confusion_matrix[1,1]+ confusion_matrix[1,0])))
							</div>
							<div class="output" style="float:right; width:45%">
								<div style="float:left; width:50%">
									Accuracy Score: 0.890151515152<br>
									Confusion Matrix: <br>
									[[6815    0]<br>
								 	[ 841    0]]<br>
									Sensitivity: 1.0<br>
									Specificity: 0.0
								</div>
								<img src="assets/img/baselineconfusionmatrix.png" style="float:right; width:50%"/>
							</div>
						</div>
						<div style="clear:both;width:100%">
							<div class="output" style="float:right; width:45%">
								<img src="assets/img/baseline-rocauc.png" style=" width:80%"/>
							</div>
							<div class="coding" style="float:left; width:50%">
								import matplotlib.pyplot as plt<br>
								preds = dumb.predict_proba(X_test)[:,1]<br>
								fpr, tpr, _ = metrics.roc_curve(y_test, preds)<br>
								roc_auc = metrics.auc(fpr,tpr)<br>
								plt.figure()<br>
								lw = 2<br>
								plt.plot(fpr, tpr, color='red',lw=lw, label='ROC curve (area = %0.2f)' % roc_auc)<br>
								plt.plot([0, 1], [0, 1], color='navy', lw=lw, linestyle='--')<br>
								plt.xlim([0.0, 1.0])<br>
								plt.ylim([0.0, 1.05])<br>
								plt.xlabel('False Positive Rate')<br>
								plt.ylabel('True Positive Rate')<br>
								plt.title('Receiver operating characteristic example')<br>
								plt.legend(loc="lower right")<br>
								plt.show()<br>
							</div>
						</div>
					</section>
					<section>
						<h5>Decision Tree</h5>
						<div class="coding" style="clear:both;width:100%">
							from sklearn import tree<br>
							ctree = tree.DecisionTreeClassifier(random_state=1, max_depth=3)<br>
							ctree.fit(X_train, y_train)<br>
						</div>
						<div style="clear:both">
							<img src="assets/img/decisiontree-enrolments.png" height="300px"/>
						</div>
					</section>
					<section>
						<div style="clear:both;width:100%">
							<div class="coding" style="float:left; width:50%">
								y_pred_class = ctree.predict(X_test)<br>
								print('Accuracy Score:', metrics.accuracy_score(y_test, y_pred_class))<br>
								print('Confusion Matrix:', metrics.confusion_matrix(y_test, y_pred_class))<br>
								print('Sensitivity:',(confusion_matrix[0,0]/(confusion_matrix[0,1]+ confusion_matrix[0,0])))<br>
								print('Specificity:',(confusion_matrix[1,1]/(confusion_matrix[1,1]+ confusion_matrix[1,0])))<br>
							</div>
							<div class="output" style="float:right; width:45%">
								<div style="float:left; width:50%">
									Accuracy Score: 0.890151515152<br>
									Confusion Matrix: <br>
									[[6815    0]<br>
									 [ 841    0]]<br>
									Sensitivity: 1.0<br>
									Specificity: 0.0
								</div>
								<img src="assets/img/baselineconfusionmatrix.png" style="float:right; width:50%"/>
							</div>
							<div class="coding" style="float:left; width:50%">
								preds = ctree.predict_proba(X_test)[:,1]<br>
								...<br>
								plt.show()<br>
							</div>
							<div class="output" style="float:right; width:45%">
								<img src="assets/img/decision-tree-rocauc.png" style=" width:80%"/>
							</div>
						</div>
					</section>


					<section>
						<h5>Logistic Regression</h5>
						<div class="coding" style="clear:both;width:100%;margin-bottom:0px!important">
							from sklearn.linear_model import LogisticRegression<br>
							logreg = LogisticRegression()<br>
							logreg.fit(X_train, y_train)<br>
							zip(all_ftcolumns, logreg.coef_[0])<br>
							print(logreg.fit(X_train, y_train))<br>
						</div>
						<div class="output" style="clear:both;width:100%;margin-top:10px">
							LogisticRegression(C=1.0, class_weight=None, dual=False, fit_intercept=True, intercept_scaling=1, max_iter=100, multi_class='ovr', n_jobs=1, penalty='l2', random_state=None, solver='liblinear', tol=0.0001, verbose=0, warm_start=False)<br>
						</div>
						<div style="clear:both;width:100%">
							<div class="coding" style="float:left; width:50%">
								y_pred_class = logreg.predict(X_test)<br>
								print('Accuracy Score:', metrics.accuracy_score(y_test,y_pred_class))<br>
								print('Confusion Matrix:', metrics.confusion_matrix(y_test, y_pred_class))<br>
								print('Sensitivity:',(confusion_matrix[0,0]/(confusion_matrix[0,1]+ confusion_matrix[0,0])))<br>
								print('Specificity:',(confusion_matrix[1,1]/(confusion_matrix[1,1]+ confusion_matrix[1,0])))
							</div>
							<div class="output" style="float:right; width:45%">
								<div style="float:left; width:50%">
									Accuracy Score: 0.890151515152<br>
									Confusion Matrix: [[6815    0]<br>
									 [ 841    0]]<br>
									Sensitivity: 1.0<br>
									Specificity: 0.0
								</div>
								<img src="assets/img/logregconfusinomatrix.png" style="float:right; width:50%"/>
							</div>
							<div class="coding" style="float:left; width:50%">
								preds = dumb.predict_proba(X_test)[:,1]<br>
								...<br>
								plt.show()
							</div>
							<div class="output" style="float:right; width:45%">
								<img src="assets/img/logreg-rocauc.png" style=" width:80%"/>
							</div>
						</div>
					</section>


					<section>
						<h5>KNN Classifier</h5>
						<div class="coding" style="clear:both; width:100%">
							from sklearn.neighbors import KNeighborsClassifier<br>
							KNN_model = KNeighborsClassifier(5)<br>
							KNN_model.fit(X_train, y_train)<br>
						</div>
						<div style="clear:both;width:100%">
							<div class="coding" style="float:left; width:55%">
								y_pred_class = KNN_model.predict(X_test)<br>print('Accuracy Score:', metrics.accuracy_score(y_test,y_pred_class))<br>
								print('Confusion Matrix:', metrics.confusion_matrix(y_test, y_pred_class))<br>
								print('Sensitivity:',(confusion_matrix[0,0]/(confusion_matrix[0,1]+ confusion_matrix[0,0])))<br>
								print('Specificity:',(confusion_matrix[1,1]/(confusion_matrix[1,1]+ confusion_matrix[1,0])))<br>
							</div>
							<div class="output" style="float:right; width:40%">
								<div style="float:left; width:50%">
									Accuracy Score: 0.879440961338<br>
									Confusion Matrix: <br>
									[[6719   96]<br>
									 [ 827   14]]<br>
									Sensitivity: 0.985913426266<br>
									Specificity: 0.0166468489893
								</div>
								<img src="assets/img/knnconfusionmatrix.png" style="float:right; width:50%"/>
							</div>
							<div class="coding" style="float:left; width:50%">
								preds = KNN_model.predict_proba(X_test)[:,1]<br>
								...<br>
								plt.show()<br>
							</div>
							<div class="output" style="text-align:center; float:right; width:45%">
								<img src="assets/img/knnclass-rocauc.png" style=" width:80%"/>
							</div>
						</div>
					</section>
					<section>
						<h5>Random Forest</h5>
						<div class="coding" style="clear:both;width:100%">
							from sklearn.ensemble import RandomForestClassifier<br>
							rfclf = RandomForestClassifier(n_estimators=400, max_features=2, oob_score=True, random_state=1,class_weight='balanced')<br>
							rfclf.fit(dummydata[all_ftcolumns], dummydata.Cancelled)<br>
							rfclf.oob_score_<br>
						</div>
						<div class="output" style="clear:both;width:100%;margin-top:10px">
							0.89305074782835869
						</div>
						<div style="clear:both;width:100%">
							<div class="coding" style="float:left; width:55%">
								y_pred_class = rfclf.predict(X_test)<br>
								print('Accuracy Score:', metrics.accuracy_score(y_test,y_pred_class))<br>
								print('Confusion Matrix:',metrics.confusion_matrix(y_test, y_pred_class))<br>
								print('Sensitivity:',(confusion_matrix[0,0]/(confusion_matrix[0,1]+ confusion_matrix[0,0])))<br>
								print('Specificity:',(confusion_matrix[1,1]/(confusion_matrix[1,1]+ confusion_matrix[1,0])))
							</div>
							<div class="output" style="float:right; width:40%">
								<div style="float:left; width:50%">
									Accuracy Score: 1.0<br>
									Confusion Matrix: <br>
									[[6815    0]<br>
									 [   0  841]]<br>
									Sensitivity: 1.0<br>
									Specificity: 1.0<br>
								</div>
								<img src="assets/img/randomforest1confusionmatrix.png" style="float:right; width:50%"/>
							</div>
						</div>
						<div style="clear:both;width:100%">
							<div class="output" style="text-align:center; float:right; width:45%">
								<img src="assets/img/randomforest1-rocauc.png" style=" width:80%"/>
							</div>
							<div class="coding" style="float:left; width:50%">
								preds = rfclf.predict_proba(X_test)[:,1]<br>
								...<br>
								plt.show()
							</div>
						</div>
					</section>
					<section>
						<h3>TUNING THE MODEL</h3>
						<p>Removing some of the data that could be screwing with the model:</p>
						<div class="coding" style="float:left; width:50% !important; margin-top:10px">
							feature_importance = pd.DataFrame({'feature':all_ftcolumns, 'importance':rfclf.feature_importances_})<br>
							feature_importance.sort('importance',ascending=False)<br>
						</div>
						<div class="output" style="float:right; width:45%">
							<img src="assets/img/randomforest1-features-list.png" style="width:70%"/>
						</div>
						<div class="coding" style="float:left; width:50%">
							all_ftcolumns.remove('EnrolDate')<br>
							all_ftcolumns.remove('DaysLeadtoEnroled')<br>
							all_ftcolumns.remove('DaysEnroltoStart')<br>
							all_ftcolumns.remove('DaysInvoicetoEnrol')<br>
							all_ftcolumns.remove('EnrolWeek')<br>
							all_ftcolumns.remove('EnrolHour')<br>
							all_ftcolumns.remove('Startdate')<br>
							all_ftcolumns.remove('Enddate')<br>
							all_ftcolumns.remove('Month')<br>
							all_ftcolumns.remove('APAC')<br>
							from sklearn.ensemble import RandomForestClassifier<br>
							rfclf = RandomForestClassifier(n_estimators=400, max_features=2, oob_score=True, random_state=1,class_weight='balanced')<br>
							rfclf.fit(dummydata[all_ftcolumns], dummydata.Cancelled)<br>
						</div>
						<div class="output"style="float:right; width:45%">
							<div style="float:left; width:40%">
								Accuracy Score: 0.942267502612<br>
								Confusion Matrix: <br>
								[[6412  403]<br>
								 [  39  802]]<br>
								Sensitivity: 0.940865737344<br>
								Specificity: 0.953626634958
							</div>
							<img src="assets/img/randomforest2confusionmatrix.png" style="float:right; width:50%"/>
						</div>
					</section>
					<section>
						<div class="coding" style="clear:both; width:100% !important">
							preds = rfclf.predict_proba(X_test)[:,1]<br>
							...<br>
							plt.show()<br>
						</div>
						<div class="output" style="text-align:center">
							<img src="assets/img/randomforest2-rocauc.png" style=" width:80%"/>
						</div>
					</section>
					<section>
						<h3>CHECKING THE MODEL</h3>
						<div class="coding" style="float:left; width:30% !important; margin-top:10px">
							feature_importance = pd.DataFrame({'feature':all_ftcolumns, 'importance':rfclf.feature_importances_})<br>
							feature_importance.sort('importance',ascending=False)<br>
						</div>
						<div class="output" style="text-align:center;float:right; width:65%">
							<img src="assets/img/randomforest2-features-list.png" style="width:70%"/>
						</div>
					</section>
					<section>
						<h3>DEPLOYING THE MODEL</h3>
						<p>???</p>
					</section>
				</section>
				<section>
					<section data-background-image="assets/img/whatnext.gif">
						<h1>NEXT STEPS</h1>
					</section>
					<section>
						<h2>Vertical Slide 1</h2>
					</section>
				</section>
				<section  data-background-color="black">
					<img src="assets/img/thankyou.gif"/>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>

		<script src="js/reveal.js"></script>

		<script>
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>

